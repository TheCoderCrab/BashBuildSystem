#!/bin/bash

# Usage: sbs <verb>
# verbs: help   : Shows this page and exists
#        build  : build the project
#        clean  : Clean the build directory and sbs' tmp directory
#        update : Update SBS installation from github to match the latest release
# If no verb is specified then 'help' is deduced

VERB=${1:-"help"}

PROJECT_DIR=${PROJECT_DIR:-$PWD}
PROJECT_FILE=${PROJECT_FILE:-"${PROJECT_DIR}/sbs.project"}

# You may add more verbs simply by creating more functions
# For example:
# custom_verb() {
#     echo "Custom Verb!"
# }
# And this verb would be invoked with: 'sbs custom_verb'
# If you want a function to not be a verb, then:
#     add its name to the 'NOT_VERB' array
# For example:
# not_verb_just_a_function() {
#     echo "This is not a verb"
# }
# NOT_VERB=("other_non_verb_function" "not_verb_just_a_function")

NOT_VERB=(remove_update_files)

help() {
    echo "Usage: sbs <verb>
verbs: help  : Shows this page and exists
       build : build the project
       clean : Clean the build directory and sbs' tmp directory
       update: Update SBS installation from github to match the latest release
If no verb is specified then 'help' is deduced"
}

build() {
    source .sbs/sbs.bash
}

clean() {
    if [[ -f ${PROJECT_FILE} ]]; then
        source ${PROJECT_FILE}
    else
        echo "Project file not found!"
        exit 1
    fi
    BUILD_DIR=${BUILD_DIR:-"${PROJECT_DIR}/build/"}
    _RBDIR=${_RBDIR:-"${BUILD_DIR}/"}
    [[ -d "${_RBDIR}/debug/obj" ]] && rm -rf "${_RBDIR}/debug/obj"
    [[ -d "${_RBDIR}/release/obj" ]] && rm -rf "${_RBDIR}/release/obj"
}

remove_update_files() {
    echo "Removing temporary file..."
    if [[ $(basename ${PWD}) = "__update_sbs_tmp" ]]; then
        cd ..
    fi
    rm -rf __update_sbs_tmp
    if [[ $? -ne 0 ]]; then
        echo "Problem while trying to delete temporary files!"
        echo "Try deleting '__update_sbs_tmp' by yourself"
        exit 1
    fi
}

update() {
    mkdir -p __update_sbs_tmp
    cd __update_sbs_tmp

    if [[ ! $(command -v jq) ]]; then
        echo "Cannot find command jq, please install it first"
        exit 1
    fi

    GITHUB_API_LATEST="https://api.github.com/repos/TheCoderCrab/ShellBuildSystem/releases/latest"

    echo "Fetching update meta-data from: \"${GITHUB_API_LATEST}\"..."

    if [[ $(command -v wget) ]]; then
        TAG_NAME=$(wget -O - -q ${GITHUB_API_LATEST} | jq -r ".tag_name")
    elif [[ $(command -v curl) ]]; then
        TAG_NAME=$(curl -s ${GITHUB_API_LATEST} | jq -r ".tag_name")
    else
        echo "Please install wget or curl before trying to update"
        cd ..
        remove_update_files
        exit 1
    fi

    
    if [[ -f .sbs/sbs.version ]]; then
        CURRENT_VERSION=$(cat .sbs/sbs.version)
    else
        CURRENT_VERSION="unknown"
    fi

    echo "Latest version: ${TAG_NAME}"
    echo "Current version: ${CURRENT_VERSION:-"unknown"}"

    if [[ ${CURRENT_VERSION} != ${TAG_NAME} ]]; then
        echo "Installing new update..."
    else
        echo "Latest update already installed"
        exit 0
    fi

    UPDATE_URL="https://github.com/TheCoderCrab/ShellBuildSystem/archive/${TAG_NAME}.tar.gz"
    
    echo "Downloading update..."
    
    if [[ $(command -v wget) ]]; then
        CMD="wget"
    elif [[ $(command -v curl) ]]; then
        CMD="curl"
    fi
    ${CMD} ${UPDATE_URL}
    if [[ $? -ne 0 ]]; then
        echo "Problem while downloading the update files!"
        remove_update_files
        exit 1
    fi
    echo "Extracting files..."
    tar -xzf ${TAG_NAME}.tar.gz
    if [[ $? -ne 0 ]]; then
        echo "Problem while extracting the update files!"
        remove_update_files
        exit 1
    fi
    echo "Copying new files to .sbs directory..."
    \cp -r ShellBuildSystem*/.sbs/* ../.sbs
    if [[ $? -ne 0 ]]; then
        echo "Problem while copying the update files!"
        remove_update_files
        exit 1
    fi
    cd ..
    remove_update_files
    echo ${TAG_NAME} > .sbs/sbs.version
    echo "Updated sbs!"
}

if [[ $(command -v ${VERB}) && ! ${NOT_VERB[@]} =~ (^|[[:space:]])"${VERB}"($|[[:space:]]) ]]; then
    ${VERB}
else
    echo "Unknown verb: ${VERB}"
fi