#!/bin/bash

# Usage: sbs <verb>
# verbs: help   : Shows this page and exists
#        build  : build the project
#        clean  : Clean the build directory and sbs' tmp directory
#        update : Update SBS installation from github to match the latest release
# If no verb is specified then 'help' is deduced

source .sbs/sbscfg.bash

VERB=${1:-"help"}

PROJECT_DIR=${PROJECT_DIR:-$PWD}
PROJECT_FILE=${PROJECT_FILE:-"${PROJECT_DIR}/sbs.project"}

remove_update_files() {
    echo "Removing temporary file..."
    if [[ $(basename ${PWD}) = "__update_sbs_tmp" ]]; then
        cd ..
    fi
    rm -rf __update_sbs_tmp
    if [[ $? -ne 0 ]]; then
        echo "Problem while trying to delete temporary files!"
        echo "Try deleting '__update_sbs_tmp' by yourself"
        exit 1
    fi
}

if [[ ${VERB} = "help" ]]; then
    echo "Usage: sbs <verb>
verbs: help  : Shows this page and exists
       build : build the project
       clean : Clean the build directory and sbs' tmp directory
       update: Update SBS installation from github to match the latest release
If no verb is specified then 'help' is deduced"
elif [[ ${VERB} = "build" ]]; then
    source .sbs/sbs.bash
elif [[ ${VERB} = "clean" ]]; then
    source ${PROJECT_FILE}
    BUILD_DIR=${BUILD_DIR:-"${PROJECT_DIR}/build/"}
    _RBDIR=${_RBDIR:-"${BUILD_DIR}/"}
    [[ -d "${_RBDIR}/debug/obj" ]] && rm -rf "${_RBDIR}/debug/obj"
    [[ -d "${_RBDIR}/release/obj" ]] && rm -rf "${_RBDIR}/release/obj"
elif [[ ${VERB} = "update" ]]; then
    mkdir -p __update_sbs_tmp
    cd __update_sbs_tmp
    echo "Downloading update..."
    
    if [[ command -v wget ]]; then
        CMD="wget"
    elif [[ command -v curl ]]; then
        CMD="curl"
    else
        echo "Please install wget or curl before trying to update"
        cd ..
        remove_update_files
        exit 1
    fi
    ${CMD} ${UPDATE_URL}
    if [[ $? -ne 0 ]]; then
        echo "Problem while downloading the update files!"
        remove_update_files
        exit 1
    fi
    echo "Extracting files..."
    tar -xzf latest.tar.gz
    if [[ $? -ne 0 ]]; then
        echo "Problem while extracting the update files!"
        remove_update_files
        exit 1
    fi
    echo "Copying new files to .sbs directory..."
    \cp -r ShellBuildSystem-latest/.sbs/* ../.sbs
    if [[ $? -ne 0 ]]; then
        echo "Problem while copying the update files!"
        remove_update_files
        exit 1
    fi
    cd ..
    remove_update_files
    echo "Updated sbs!"
elif [[ ${VERB} = "custom" ]]; then
    # You may add custom verbs
    echo "You may add custom verbs"
else
    echo "Unknown verb: ${VERB}"
    exit 1
fi
